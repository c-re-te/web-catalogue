// Define the data in JSON
var artworks = {
  "Crema": {
    "prov": "CR",
    "lat": 45.36264,
    "long": 9.68176,
    "opere_id": [
      1,
      2,
      3,
      4,
      5,
      6,
      7,
      8,
      9,
      10,
      11,
      12,
      13,
      14,
      15,
      16,
      17,
      18,
      19,
      20,
      21,
      22,
      23,
      24,
      25,
      28,
      30,
      31,
      32,
      33,
      34,
      35,
      36,
      37,
      39,
      72,
      73,
      74,
      75,
      87,
      92
    ],
    "count": 41
  },
  "Credera Rubbiano": {
    "prov": "CR",
    "lat": 45.30327,
    "long": 9.65606,
    "opere_id": [
      27
    ],
    "count": 1
  },
  "Madignano": {
    "prov": "CR",
    "lat": 45.34567,
    "long": 9.72326,
    "opere_id": [
      29
    ],
    "count": 1
  },
  "Cremona": {
    "prov": "CR",
    "lat": 45.13325,
    "long": 10.02129,
    "opere_id": [
      38,
      40,
      42,
      43,
      47,
      49,
      50,
      51,
      52,
      53,
      54,
      55,
      56,
      57,
      58,
      59,
      60,
      61,
      62,
      63,
      85,
      86,
      93,
      94,
      95,
      96,
      97,
      98,
      99,
      100,
      101,
      102,
      103,
      104,
      141,
      142,
      144,
      145,
      146,
      147,
      149,
      150,
      151
    ],
    "count": 43
  },
  "Sergnano": {
    "prov": "CR",
    "lat": 45.42755,
    "long": 9.70122,
    "opere_id": [
      41
    ],
    "count": 1
  },
  "Castelleone": {
    "prov": "CR",
    "lat": 45.29579,
    "long": 9.76091,
    "opere_id": [
      44,
      64,
      65,
      117
    ],
    "count": 4
  },
  "Casalmaggiore": {
    "prov": "CR",
    "lat": 44.98981,
    "long": 10.42055,
    "opere_id": [
      45,
      46
    ],
    "count": 2
  },
  "Soncino": {
    "prov": "CR",
    "lat": 45.40033,
    "long": 9.86845,
    "opere_id": [
      48,
      79,
      80,
      81,
      81,
      83,
      84,
      143
    ],
    "count": 8
  },
  "Palazzo Pignano": {
    "prov": "CR",
    "lat": 45.39007,
    "long": 9.56956,
    "opere_id": [
      66,
      67,
      68,
      69,
      70,
      71
    ],
    "count": 6
  },
  "Izano": {
    "prov": "CR",
    "lat": 45.35552,
    "long": 9.75138,
    "opere_id": [
      76,
      77,
      78
    ],
    "count": 3
  },
  "Pizzighettone": {
    "prov": "CR",
    "lat": 45.1869,
    "long": 9.78781,
    "opere_id": [
      88
    ],
    "count": 1
  },
  "Ripalta Arpina": {
    "prov": "CR",
    "lat": 45.30187,
    "long": 9.72896,
    "opere_id": [
      89
    ],
    "count": 1
  },
  "Cremosano": {
    "prov": "CR",
    "lat": 45.39467,
    "long": 9.63826,
    "opere_id": [
      90
    ],
    "count": 1
  },
  "Capergnanica": {
    "prov": "CR",
    "lat": 45.33869,
    "long": 9.64475,
    "opere_id": [
      91
    ],
    "count": 1
  },
  "Pavia": {
    "prov": "PV",
    "lat": 45.19205,
    "long": 9.15917,
    "opere_id": [
      105,
      106,
      107,
      108,
      118,
      119,
      120,
      121,
      122,
      123,
      124,
      125,
      126,
      127,
      128,
      129,
      130,
      131,
      132,
      133,
      134,
      135,
      136,
      137
    ],
    "count": 24
  },
  "Busseto": {
    "prov": "PR",
    "lat": 44.9794,
    "long": 10.04331,
    "opere_id": [
      109,
      110,
      111,
      112,
      148
    ],
    "count": 5
  },
  "Lodi": {
    "prov": "LO",
    "lat": 45.31357,
    "long": 9.50286,
    "opere_id": [
      113,
      114,
      115,
      116
    ],
    "count": 4
  },
  "Piacenza": {
    "prov": "PC",
    "lat": 45.05242,
    "long": 9.69342,
    "opere_id": [
      139,
      140
    ],
    "count": 2
  },
  "Ceresara": {
    "prov": "MN",
    "lat": 45.26228,
    "long": 10.56958,
    "opere_id": [
      152,
      169
    ],
    "count": 2
  },
  "Mantova": {
    "prov": "MN",
    "lat": 45.16031,
    "long": 10.79784,
    "opere_id": [
      153,
      154,
      155,
      159,
      160,
      161,
      162,
      164,
      165,
      167,
      172,
      178,
      182,
      184,
      185,
      187,
      188,
      189,
      193,
      195,
      196,
      199,
      210,
      214,
      215,
      216,
      217,
      218,
      219,
      220,
      221,
      222,
      223,
      224,
      225,
      226,
      227,
      228,
      229,
      230,
      231,
      232,
      244,
      245,
      246,
      248,
      249,
      250
    ],
    "count": 48
  },
  "San Benedetto Po": {
    "prov": "MN",
    "lat": 45.04612,
    "long": 10.93367,
    "opere_id": [
      156,
      157,
      175,
      212,
      213
    ],
    "count": 5
  },
  "San Giorgio Bigarello, Stradella": {
    "prov": "MN",
    "lat": 45.17245,
    "long": 10.87327,
    "opere_id": [
      163,
      243
    ],
    "count": 2
  },
  "Sermide, Santa Croce": {
    "prov": "MN",
    "lat": 44.98379,
    "long": 11.25329,
    "opere_id": [
      166
    ],
    "count": 1
  },
  "Viadana": {
    "prov": "MN",
    "lat": 44.93553,
    "long": 10.51898,
    "opere_id": [
      168,
      174,
      203,
      204,
      208,
      240,
      241
    ],
    "count": 7
  },
  "Bozzolo": {
    "prov": "MN",
    "lat": 45.10324,
    "long": 10.47988,
    "opere_id": [
      170
    ],
    "count": 1
  },
  "Parma": {
    "prov": "PR",
    "lat": 44.79935,
    "long": 10.32618,
    "opere_id": [
      171
    ],
    "count": 1
  },
  "Castel Goffredo": {
    "prov": "MN",
    "lat": 45.29403,
    "long": 10.473,
    "opere_id": [
      173
    ],
    "count": 1
  },
  "Castel dâ€™Ario": {
    "prov": "MN",
    "lat": 45.18798,
    "long": 10.97449,
    "opere_id": [
      176,
      180
    ],
    "count": 2
  },
  "Sabbioneta, Villa Pasquali": {
    "prov": "MN",
    "lat": 44.99943,
    "long": 10.5155,
    "opere_id": [
      177
    ],
    "count": 1
  },
  "Pegognaga": {
    "prov": "MN",
    "lat": 44.99456,
    "long": 10.85967,
    "opere_id": [
      179,
      205
    ],
    "count": 2
  },
  "Piubega": {
    "prov": "MN",
    "lat": 45.22677,
    "long": 10.53195,
    "opere_id": [
      183
    ],
    "count": 1
  },
  "Parigi": {
    "prov": "",
    "lat": 48.85341,
    "long": 2.3488,
    "opere_id": [
      186,
      191
    ],
    "count": 2
  },
  "Mantova, Frassino": {
    "prov": "MN",
    "lat": 45.16016,
    "long": 10.82059,
    "opere_id": [
      190
    ],
    "count": 1
  },
  "Curtatone, San Silvestro": {
    "prov": "MN",
    "lat": 45.15253,
    "long": 10.71989,
    "opere_id": [
      192
    ],
    "count": 1
  },
  "Borgo Virgilio": {
    "prov": "MN",
    "lat": 45.08266,
    "long": 10.78748,
    "opere_id": [
      194
    ],
    "count": 1
  },
  "Suzzara": {
    "prov": "MN",
    "lat": 44.99187,
    "long": 10.74309,
    "opere_id": [
      197
    ],
    "count": 1
  },
  "Suzzara, Sailetto": {
    "prov": "MN",
    "lat": 44.99187,
    "long": 10.74309,
    "opere_id": [
      198
    ],
    "count": 1
  },
  "Pieve di Coriano": {
    "prov": "MN",
    "lat": 45.03388,
    "long": 11.1078,
    "opere_id": [
      200
    ],
    "count": 1
  },
  "Goito": {
    "prov": "MN",
    "lat": 45.25076,
    "long": 10.66121,
    "opere_id": [
      201
    ],
    "count": 1
  },
  "Volta Mantovana, Cereta": {
    "prov": "MN",
    "lat": 45.30503,
    "long": 10.64125,
    "opere_id": [
      206
    ],
    "count": 1
  },
  "Asola": {
    "prov": "MN",
    "lat": 45.22018,
    "long": 10.41214,
    "opere_id": [
      211
    ],
    "count": 1
  },
  "Medole": {
    "prov": "MN",
    "lat": 45.32588,
    "long": 10.51357,
    "opere_id": [
      233,
      234,
      235,
      236,
      237,
      238,
      239
    ],
    "count": 7
  },
  "Revere": {
    "prov": "MN",
    "lat": 45.05207,
    "long": 11.13059,
    "opere_id": [
      242
    ],
    "count": 1
  },
  "Firenze": {
    "prov": "FI",
    "lat": 43.77925,
    "long": 11.24626,
    "opere_id": [
      247
    ],
    "count": 1
  }
}

// To updating
if (typeof map !== 'undefined' && map) {
  map.remove(); // If map exists, remove it
}

// Create map
var map = L.map('mapid').setView([43.76956, 11.25581], 5);

// Add base layer
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// ************
// MAIN WORFLOW
// ************

// 1. DEFINE THE CLUSTER

var markers = L.markerClusterGroup({
  iconCreateFunction: function (cluster) {
    // 1a. Count the value of artworks in the cluster
    var totalArtworks = 0;
    cluster.getAllChildMarkers().forEach(function (marker) {
      totalArtworks += marker.options.count; // Add the number to the marker
    });

    // 1b. Create an incon for the cluster
    return L.divIcon({
      html: `<div class="cluster-circle">${totalArtworks}</div>`, // See CSS below
      className: "cluster-icon",
      iconSize: [40, 40],
    });
  },

  // 1c. Custom the area covered by the cluster
  polygonOptions: {
    color: "#C85466",     // Polygon Boarder
    weight: 2,
    opacity: 0.8,
    fillColor: "#EFCED3", // Polygon Area
    fillOpacity: 0.4
  }
});

// 2. DEFINE THE PIN FOR THE SINGLE LOCATION

// 2a. Set base pin
var customPin = L.icon({
  // Icon
  iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
  iconSize: [25, 41], 
  iconAnchor: [12, 41],

  // Popup
  popupAnchor: [1, -34], 
  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
  shadowSize: [41, 41],
  shadowAnchor: [12, 41],
});

// 2b. Dynamically change pin color
function createColoredIcon(color) {

  // Use SVG to change color
  const svgMarker = `
      <svg xmlns="http://www.w3.org/2000/svg" width="25" height="41" viewBox="0 0 25 41">
          <path fill="${color}" d="M12.5 0C7 0 2.5 4.5 2.5 10.5S12.5 41 12.5 41s10-20.5 10-30.5S18 0 12.5 0z" />
          <circle fill="#ffffff" cx="12.5" cy="10.5" r="4.5" />
      </svg>`;
  return L.divIcon({
    className: '',
    html: svgMarker,
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
  });
}

// 2c.Add a mar
for (let city in artworks) {
  const cityData = artworks[city];
  if (cityData.lat && cityData.long) {
    const opereText = cityData.count === 1 ? "Un'opera trovata" : `${cityData.count} opere trovate`;

    const popupContent = `
          <b>${city}</b> ${cityData.prov ? `(${cityData.prov})` : ''}<br>
          ${opereText}<br>
          <div class="row justify-content-center align-items-center">
            <button class="btn btn-primary mt-2" onclick="debug('${city}')"><small>Ricerca <i class="bi bi-search"></i></small></button>
          </div>
      `;
    const marker = L.marker([cityData.lat, cityData.long], {
      icon: createColoredIcon('#640817'), // Set color on pins
      count: cityData.count               // Set number on clusters
    }).bindPopup(popupContent);

    markers.addLayer(marker);
  }
}

// Add to map
map.addLayer(markers);

// ************

// Custom CSS for the cluster
var style = document.createElement('style');
style.innerHTML = `
  .cluster-circle {
      width: 30px;
      height: 30px;
      background-color: #B10B25;
      color: white;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 14px;
      font-weight: bold;
      text-align: center;
  }

  .cluster-icon {
      width: 30px;
      height: 30px;
      line-height: 30px;
      border-radius: 50%;
  }
`;
document.head.appendChild(style);

// ************

// Add interaction
function debug(city) {
  console.log(`You clicked on: ${city}`);
  // - - - - <Function body to refine the results (new query)> - - - -
}
